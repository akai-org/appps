---
import { octokit } from "../utilities/github";
import Project from "../components/Project.astro";
import MainPageLayout from "../layouts/MainPageLayout.astro";
import { isProd } from "../utilities/env";

const per_page = isProd ? 100 : 3;
const res = await octokit.request(
  `GET /orgs/{org}/repos?per_page=${per_page}`,
  {
    org: "akai-org",
    headers: {
      "X-GitHub-Api-Version": "2022-11-28",
    },
  },
);
console.log(`fetching ${res.data.length} projects`);

const projects = await Promise.all(
  res.data.map(async (repo: any, i: number) => {
    const { data } = await octokit.request(
      `GET /repos/{owner}/{repo}/languages`,
      {
        owner: "akai-org",
        repo: repo.name,
        headers: {
          "X-GitHub-Api-Version": "2022-11-28",
        },
      },
    );
    return {
      index: i + 1,
      name: repo.name,
      url: repo.html_url,
      languages: Object.keys(data),
    };
  }),
);
---
<MainPageLayout title="Akai Apps">
    <main>
      <ul class="flex flex-col gap-y-3 p-3">
        {
          projects.map((project: any, i) => (
            <li>
              <Project {...project} />
            </li>
          ))
        }
      </ul>
    </main>
</MainPageLayout>
